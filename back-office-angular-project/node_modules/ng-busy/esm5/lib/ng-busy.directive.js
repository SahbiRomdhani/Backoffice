/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { ApplicationRef, ComponentFactoryResolver, Directive, ElementRef, EventEmitter, Injector, Input, Output, Renderer2, TemplateRef, ViewContainerRef } from '@angular/core';
import { BusyTrackerService } from './service/busy-tracker.service';
import { BusyConfigHolderService } from './service/busy-config-holder.service';
import { Subscription } from 'rxjs';
import { NgBusyComponent } from './component/ng-busy/ng-busy.component';
import { InstanceConfigHolderService } from './service/instance-config-holder.service';
import { isPromise } from './util/isPromise';
var NgBusyDirective = /** @class */ (function () {
    function NgBusyDirective(configHolder, instanceConfigHolder, resolver, tracker, appRef, vcr, element, renderer, injector) {
        var _this = this;
        this.configHolder = configHolder;
        this.instanceConfigHolder = instanceConfigHolder;
        this.resolver = resolver;
        this.tracker = tracker;
        this.appRef = appRef;
        this.vcr = vcr;
        this.element = element;
        this.renderer = renderer;
        this.injector = injector;
        this.busyStart = new EventEmitter();
        this.busyStop = new EventEmitter();
        this.isLoading = false;
        this.busyEmitter = new EventEmitter();
        this.onStartSubscription = tracker.onStartBusy.subscribe(function () {
            setTimeout(function () {
                _this.recreateBusyIfNecessary();
                _this.isLoading = true;
                _this.busyEmitter.emit(_this.isLoading);
                _this.busyStart.emit();
            }, 0);
        });
        this.onStopSubscription = tracker.onStopBusy.subscribe(function () {
            _this.isLoading = false;
            _this.busyEmitter.emit(_this.isLoading);
            _this.busyStop.emit();
        });
    }
    Object.defineProperty(NgBusyDirective.prototype, "options", {
        get: /**
         * @return {?}
         */
        function () {
            return this._option;
        },
        set: /**
         * @param {?} op
         * @return {?}
         */
        function (op) {
            this._option = op;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    NgBusyDirective.prototype.ngDoCheck = /**
     * @return {?}
     */
    function () {
        this.optionsNorm = this.normalizeOptions(this.options);
        this.instanceConfigHolder.config = this.optionsNorm;
        this.tracker.load({
            busyList: this.optionsNorm.busy,
            delay: this.optionsNorm.delay,
            minDuration: this.optionsNorm.minDuration
        });
    };
    /**
     * @return {?}
     */
    NgBusyDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.destroyComponents();
        this.onStartSubscription.unsubscribe();
        this.onStopSubscription.unsubscribe();
    };
    /**
     * @return {?}
     */
    NgBusyDirective.prototype.recreateBusyIfNecessary = /**
     * @return {?}
     */
    function () {
        if (!this.busyRef
            || this.template !== this.optionsNorm.template
            || this.templateNgStyle !== this.optionsNorm.templateNgStyle) {
            this.destroyComponents();
            this.template = this.optionsNorm.template;
            this.templateNgStyle = this.optionsNorm.templateNgStyle;
            this.createBusy();
            this.busyEmitter.emit(this.isLoading);
        }
    };
    /**
     * @param {?} options
     * @return {?}
     */
    NgBusyDirective.prototype.normalizeOptions = /**
     * @param {?} options
     * @return {?}
     */
    function (options) {
        if (!options) {
            options = { busy: [] };
        }
        else if (Array.isArray(options)
            || isPromise(options)
            || options instanceof Subscription) {
            options = { busy: options };
        }
        options = Object.assign({}, this.configHolder.config, options);
        if (!Array.isArray(options.busy)) {
            options.busy = [options.busy];
        }
        return options;
    };
    /**
     * @return {?}
     */
    NgBusyDirective.prototype.destroyComponents = /**
     * @return {?}
     */
    function () {
        if (this.busyRef) {
            this.busyRef.destroy();
        }
        if (this.componentViewRef) {
            this.appRef.detachView(this.componentViewRef);
        }
    };
    /**
     * @return {?}
     */
    NgBusyDirective.prototype.createBusy = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var factory = this.resolver.resolveComponentFactory(NgBusyComponent);
        /** @type {?} */
        var injector = Injector.create({
            providers: [
                {
                    provide: 'instanceConfigHolder',
                    useValue: this.instanceConfigHolder
                },
                {
                    provide: 'busyEmitter',
                    useValue: this.busyEmitter
                }
            ], parent: this.injector
        });
        this.template = this.optionsNorm.template;
        this.busyRef = this.vcr.createComponent(factory, 0, injector, this.generateNgContent(injector));
    };
    /**
     * @param {?} injector
     * @return {?}
     */
    NgBusyDirective.prototype.generateNgContent = /**
     * @param {?} injector
     * @return {?}
     */
    function (injector) {
        if (typeof this.template === 'string') {
            /** @type {?} */
            var element = this.renderer.createText(this.template);
            return [[element]];
        }
        if (this.template instanceof TemplateRef) {
            /** @type {?} */
            var context = {};
            /** @type {?} */
            var viewRef = this.template.createEmbeddedView(context);
            return [viewRef.rootNodes];
        }
        /** @type {?} */
        var factory = this.resolver.resolveComponentFactory(this.template);
        /** @type {?} */
        var componentRef = factory.create(injector);
        componentRef.instance.templateNgStyle = this.options.templateNgStyle;
        this.componentViewRef = componentRef.hostView;
        this.appRef.attachView(this.componentViewRef);
        return [[componentRef.location.nativeElement]];
    };
    NgBusyDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[ngBusy]',
                    providers: [BusyTrackerService, InstanceConfigHolderService]
                },] },
    ];
    /** @nocollapse */
    NgBusyDirective.ctorParameters = function () { return [
        { type: BusyConfigHolderService },
        { type: InstanceConfigHolderService },
        { type: ComponentFactoryResolver },
        { type: BusyTrackerService },
        { type: ApplicationRef },
        { type: ViewContainerRef },
        { type: ElementRef },
        { type: Renderer2 },
        { type: Injector }
    ]; };
    NgBusyDirective.propDecorators = {
        options: [{ type: Input, args: ['ngBusy',] }],
        busyStart: [{ type: Output }],
        busyStop: [{ type: Output }]
    };
    return NgBusyDirective;
}());
export { NgBusyDirective };
if (false) {
    /** @type {?} */
    NgBusyDirective.prototype.busyStart;
    /** @type {?} */
    NgBusyDirective.prototype.busyStop;
    /** @type {?} */
    NgBusyDirective.prototype.optionsNorm;
    /** @type {?} */
    NgBusyDirective.prototype.busyRef;
    /** @type {?} */
    NgBusyDirective.prototype.componentViewRef;
    /** @type {?} */
    NgBusyDirective.prototype.onStartSubscription;
    /** @type {?} */
    NgBusyDirective.prototype.onStopSubscription;
    /** @type {?} */
    NgBusyDirective.prototype.isLoading;
    /** @type {?} */
    NgBusyDirective.prototype.busyEmitter;
    /** @type {?} */
    NgBusyDirective.prototype.template;
    /** @type {?} */
    NgBusyDirective.prototype.templateNgStyle;
    /** @type {?} */
    NgBusyDirective.prototype._option;
    /** @type {?} */
    NgBusyDirective.prototype.configHolder;
    /** @type {?} */
    NgBusyDirective.prototype.instanceConfigHolder;
    /** @type {?} */
    NgBusyDirective.prototype.resolver;
    /** @type {?} */
    NgBusyDirective.prototype.tracker;
    /** @type {?} */
    NgBusyDirective.prototype.appRef;
    /** @type {?} */
    NgBusyDirective.prototype.vcr;
    /** @type {?} */
    NgBusyDirective.prototype.element;
    /** @type {?} */
    NgBusyDirective.prototype.renderer;
    /** @type {?} */
    NgBusyDirective.prototype.injector;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctYnVzeS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1idXN5LyIsInNvdXJjZXMiOlsibGliL25nLWJ1c3kuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQ0wsY0FBYyxFQUNkLHdCQUF3QixFQUN4QixTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFBRSxRQUFRLEVBQ3RCLEtBQUssRUFDTCxNQUFNLEVBQ04sU0FBUyxFQUNULFdBQVcsRUFDWCxnQkFBZ0IsRUFDakIsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDcEUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDL0UsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUVwQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDeEUsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFDdkYsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGtCQUFrQixDQUFDOztJQTZCM0MseUJBQW9CLFlBQXFDLEVBQy9DLHNCQUNBLFVBQ0EsU0FDQSxRQUNBLEtBQ0EsU0FDQSxVQUNBO1FBUlYsaUJBc0JDO1FBdEJtQixpQkFBWSxHQUFaLFlBQVksQ0FBeUI7UUFDL0MseUJBQW9CLEdBQXBCLG9CQUFvQjtRQUNwQixhQUFRLEdBQVIsUUFBUTtRQUNSLFlBQU8sR0FBUCxPQUFPO1FBQ1AsV0FBTSxHQUFOLE1BQU07UUFDTixRQUFHLEdBQUgsR0FBRztRQUNILFlBQU8sR0FBUCxPQUFPO1FBQ1AsYUFBUSxHQUFSLFFBQVE7UUFDUixhQUFRLEdBQVIsUUFBUTt5QkFyQkksSUFBSSxZQUFZLEVBQUU7d0JBQ25CLElBQUksWUFBWSxFQUFFO3lCQU1uQixLQUFLOzJCQUNvQixJQUFJLFlBQVksRUFBVztRQWN0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QXdCO2dCQVdqQixrQkFBa0I7Z0JBWnpCLGNBQWM7Z0JBU2QsZ0JBQWdCO2dCQU5oQixVQUFVO2dCQUlWLFNBQVM7Z0JBSEssUUFBUTs7OzBCQXFCckIsS0FBSyxTQUFDLFFBQVE7NEJBU2QsTUFBTTsyQkFDTixNQUFNOzswQkFwQ1Q7O1NBeUJhLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBcHBsaWNhdGlvblJlZixcbiAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBDb21wb25lbnRSZWYsXG4gIERpcmVjdGl2ZSwgRG9DaGVjayxcbiAgRWxlbWVudFJlZixcbiAgRXZlbnRFbWl0dGVyLCBJbmplY3RvcixcbiAgSW5wdXQsIE9uRGVzdHJveSxcbiAgT3V0cHV0LFxuICBSZW5kZXJlcjIsXG4gIFRlbXBsYXRlUmVmLCBUeXBlLFxuICBWaWV3Q29udGFpbmVyUmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVmlld1JlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvc3JjL2xpbmtlci92aWV3X3JlZic7XG5pbXBvcnQgeyBCdXN5VHJhY2tlclNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2UvYnVzeS10cmFja2VyLnNlcnZpY2UnO1xuaW1wb3J0IHsgQnVzeUNvbmZpZ0hvbGRlclNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2UvYnVzeS1jb25maWctaG9sZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBJQnVzeUNvbmZpZyB9IGZyb20gJy4vbW9kZWwvYnVzeS1jb25maWcnO1xuaW1wb3J0IHsgTmdCdXN5Q29tcG9uZW50IH0gZnJvbSAnLi9jb21wb25lbnQvbmctYnVzeS9uZy1idXN5LmNvbXBvbmVudCc7XG5pbXBvcnQgeyBJbnN0YW5jZUNvbmZpZ0hvbGRlclNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2UvaW5zdGFuY2UtY29uZmlnLWhvbGRlci5zZXJ2aWNlJztcbmltcG9ydCB7IGlzUHJvbWlzZSB9IGZyb20gJy4vdXRpbC9pc1Byb21pc2UnO1xuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbbmdCdXN5XScsXG4gIHByb3ZpZGVyczogW0J1c3lUcmFja2VyU2VydmljZSwgSW5zdGFuY2VDb25maWdIb2xkZXJTZXJ2aWNlXVxufSlcbmV4cG9ydCBjbGFzcyBOZ0J1c3lEaXJlY3RpdmUgaW1wbGVtZW50cyBEb0NoZWNrLCBPbkRlc3Ryb3kge1xuICBASW5wdXQoJ25nQnVzeScpXG4gIHNldCBvcHRpb25zKG9wKSB7XG4gICAgdGhpcy5fb3B0aW9uID0gb3A7XG4gIH1cblxuICBnZXQgb3B0aW9ucygpIHtcbiAgICByZXR1cm4gdGhpcy5fb3B0aW9uO1xuICB9XG5cbiAgQE91dHB1dCgpIGJ1c3lTdGFydCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQE91dHB1dCgpIGJ1c3lTdG9wID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBwcml2YXRlIG9wdGlvbnNOb3JtOiBJQnVzeUNvbmZpZztcbiAgcHJpdmF0ZSBidXN5UmVmOiBDb21wb25lbnRSZWY8TmdCdXN5Q29tcG9uZW50PjtcbiAgcHJpdmF0ZSBjb21wb25lbnRWaWV3UmVmOiBWaWV3UmVmO1xuICBwcml2YXRlIG9uU3RhcnRTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBvblN0b3BTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBpc0xvYWRpbmcgPSBmYWxzZTtcbiAgcHJpdmF0ZSBidXN5RW1pdHRlcjogRXZlbnRFbWl0dGVyPGJvb2xlYW4+ID0gbmV3IEV2ZW50RW1pdHRlcjxib29sZWFuPigpO1xuICBwdWJsaWMgdGVtcGxhdGU6IFRlbXBsYXRlUmVmPGFueT4gfCBUeXBlPGFueT47XG4gIHB1YmxpYyB0ZW1wbGF0ZU5nU3R5bGU6IHt9O1xuICBwcml2YXRlIF9vcHRpb246IGFueTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNvbmZpZ0hvbGRlcjogQnVzeUNvbmZpZ0hvbGRlclNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnN0YW5jZUNvbmZpZ0hvbGRlcjogSW5zdGFuY2VDb25maWdIb2xkZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICBwcml2YXRlIHRyYWNrZXI6IEJ1c3lUcmFja2VyU2VydmljZSxcbiAgICBwcml2YXRlIGFwcFJlZjogQXBwbGljYXRpb25SZWYsXG4gICAgcHJpdmF0ZSB2Y3I6IFZpZXdDb250YWluZXJSZWYsXG4gICAgcHJpdmF0ZSBlbGVtZW50OiBFbGVtZW50UmVmLFxuICAgIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMixcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3Rvcikge1xuICAgIHRoaXMub25TdGFydFN1YnNjcmlwdGlvbiA9IHRyYWNrZXIub25TdGFydEJ1c3kuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGlzLnJlY3JlYXRlQnVzeUlmTmVjZXNzYXJ5KCk7XG4gICAgICAgIHRoaXMuaXNMb2FkaW5nID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5idXN5RW1pdHRlci5lbWl0KHRoaXMuaXNMb2FkaW5nKTtcbiAgICAgICAgdGhpcy5idXN5U3RhcnQuZW1pdCgpO1xuICAgICAgfSwgMCk7XG4gICAgfSk7XG4gICAgdGhpcy5vblN0b3BTdWJzY3JpcHRpb24gPSB0cmFja2VyLm9uU3RvcEJ1c3kuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7XG4gICAgICB0aGlzLmJ1c3lFbWl0dGVyLmVtaXQodGhpcy5pc0xvYWRpbmcpO1xuICAgICAgdGhpcy5idXN5U3RvcC5lbWl0KCk7XG4gICAgfSk7XG4gIH1cblxuICBuZ0RvQ2hlY2soKSB7XG4gICAgdGhpcy5vcHRpb25zTm9ybSA9IHRoaXMubm9ybWFsaXplT3B0aW9ucyh0aGlzLm9wdGlvbnMpO1xuICAgIHRoaXMuaW5zdGFuY2VDb25maWdIb2xkZXIuY29uZmlnID0gdGhpcy5vcHRpb25zTm9ybTtcbiAgICB0aGlzLnRyYWNrZXIubG9hZCh7XG4gICAgICBidXN5TGlzdDogdGhpcy5vcHRpb25zTm9ybS5idXN5LFxuICAgICAgZGVsYXk6IHRoaXMub3B0aW9uc05vcm0uZGVsYXksXG4gICAgICBtaW5EdXJhdGlvbjogdGhpcy5vcHRpb25zTm9ybS5taW5EdXJhdGlvblxuICAgIH0pO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5kZXN0cm95Q29tcG9uZW50cygpO1xuICAgIHRoaXMub25TdGFydFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIHRoaXMub25TdG9wU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBwcml2YXRlIHJlY3JlYXRlQnVzeUlmTmVjZXNzYXJ5KCkge1xuICAgIGlmICghdGhpcy5idXN5UmVmXG4gICAgICB8fCB0aGlzLnRlbXBsYXRlICE9PSB0aGlzLm9wdGlvbnNOb3JtLnRlbXBsYXRlXG4gICAgICB8fCB0aGlzLnRlbXBsYXRlTmdTdHlsZSAhPT0gdGhpcy5vcHRpb25zTm9ybS50ZW1wbGF0ZU5nU3R5bGVcbiAgICApIHtcbiAgICAgIHRoaXMuZGVzdHJveUNvbXBvbmVudHMoKTtcbiAgICAgIHRoaXMudGVtcGxhdGUgPSB0aGlzLm9wdGlvbnNOb3JtLnRlbXBsYXRlO1xuICAgICAgdGhpcy50ZW1wbGF0ZU5nU3R5bGUgPSB0aGlzLm9wdGlvbnNOb3JtLnRlbXBsYXRlTmdTdHlsZTtcbiAgICAgIHRoaXMuY3JlYXRlQnVzeSgpO1xuICAgICAgdGhpcy5idXN5RW1pdHRlci5lbWl0KHRoaXMuaXNMb2FkaW5nKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG5vcm1hbGl6ZU9wdGlvbnMob3B0aW9uczogYW55KTogSUJ1c3lDb25maWcge1xuICAgIGlmICghb3B0aW9ucykge1xuICAgICAgb3B0aW9ucyA9IHsgYnVzeTogW10gfTtcbiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkob3B0aW9ucylcbiAgICAgIHx8IGlzUHJvbWlzZShvcHRpb25zKVxuICAgICAgfHwgb3B0aW9ucyBpbnN0YW5jZW9mIFN1YnNjcmlwdGlvblxuICAgICkge1xuICAgICAgb3B0aW9ucyA9IHsgYnVzeTogb3B0aW9ucyB9O1xuICAgIH1cbiAgICBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5jb25maWdIb2xkZXIuY29uZmlnLCBvcHRpb25zKTtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkob3B0aW9ucy5idXN5KSkge1xuICAgICAgb3B0aW9ucy5idXN5ID0gW29wdGlvbnMuYnVzeV07XG4gICAgfVxuICAgIHJldHVybiBvcHRpb25zO1xuICB9XG5cbiAgcHJpdmF0ZSBkZXN0cm95Q29tcG9uZW50cygpIHtcbiAgICBpZiAodGhpcy5idXN5UmVmKSB7XG4gICAgICB0aGlzLmJ1c3lSZWYuZGVzdHJveSgpO1xuICAgIH1cbiAgICBpZiAodGhpcy5jb21wb25lbnRWaWV3UmVmKSB7XG4gICAgICB0aGlzLmFwcFJlZi5kZXRhY2hWaWV3KHRoaXMuY29tcG9uZW50Vmlld1JlZik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVCdXN5KCkge1xuICAgIGNvbnN0IGZhY3RvcnkgPSB0aGlzLnJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KE5nQnVzeUNvbXBvbmVudCk7XG4gICAgY29uc3QgaW5qZWN0b3IgPSBJbmplY3Rvci5jcmVhdGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiAnaW5zdGFuY2VDb25maWdIb2xkZXInLFxuICAgICAgICAgIHVzZVZhbHVlOiB0aGlzLmluc3RhbmNlQ29uZmlnSG9sZGVyXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiAnYnVzeUVtaXR0ZXInLFxuICAgICAgICAgIHVzZVZhbHVlOiB0aGlzLmJ1c3lFbWl0dGVyXG4gICAgICAgIH1cbiAgICAgIF0sIHBhcmVudDogdGhpcy5pbmplY3RvclxuICAgIH0pO1xuICAgIHRoaXMudGVtcGxhdGUgPSB0aGlzLm9wdGlvbnNOb3JtLnRlbXBsYXRlO1xuICAgIHRoaXMuYnVzeVJlZiA9IHRoaXMudmNyLmNyZWF0ZUNvbXBvbmVudChmYWN0b3J5LCAwLCBpbmplY3RvciwgdGhpcy5nZW5lcmF0ZU5nQ29udGVudChpbmplY3RvcikpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZU5nQ29udGVudChpbmplY3RvcjogSW5qZWN0b3IpIHtcbiAgICBpZiAodHlwZW9mIHRoaXMudGVtcGxhdGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICBjb25zdCBlbGVtZW50ID0gdGhpcy5yZW5kZXJlci5jcmVhdGVUZXh0KHRoaXMudGVtcGxhdGUpO1xuICAgICAgcmV0dXJuIFtbZWxlbWVudF1dO1xuICAgIH1cbiAgICBpZiAodGhpcy50ZW1wbGF0ZSBpbnN0YW5jZW9mIFRlbXBsYXRlUmVmKSB7XG4gICAgICBjb25zdCBjb250ZXh0ID0ge307XG4gICAgICBjb25zdCB2aWV3UmVmID0gdGhpcy50ZW1wbGF0ZS5jcmVhdGVFbWJlZGRlZFZpZXcoY29udGV4dCk7XG4gICAgICByZXR1cm4gW3ZpZXdSZWYucm9vdE5vZGVzXTtcbiAgICB9XG4gICAgY29uc3QgZmFjdG9yeSA9IHRoaXMucmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkodGhpcy50ZW1wbGF0ZSk7XG4gICAgY29uc3QgY29tcG9uZW50UmVmID0gZmFjdG9yeS5jcmVhdGUoaW5qZWN0b3IpO1xuICAgIGNvbXBvbmVudFJlZi5pbnN0YW5jZS50ZW1wbGF0ZU5nU3R5bGUgPSB0aGlzLm9wdGlvbnMudGVtcGxhdGVOZ1N0eWxlO1xuICAgIHRoaXMuY29tcG9uZW50Vmlld1JlZiA9IGNvbXBvbmVudFJlZi5ob3N0VmlldztcbiAgICB0aGlzLmFwcFJlZi5hdHRhY2hWaWV3KHRoaXMuY29tcG9uZW50Vmlld1JlZik7XG4gICAgcmV0dXJuIFtbY29tcG9uZW50UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnRdXTtcbiAgfVxuXG59XG4iXX0=